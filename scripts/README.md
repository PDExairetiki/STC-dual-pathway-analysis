# Code and Data for "From Slow Feedback to Runaway Amplification: Decoupling the Dual Pathways of Intra-seasonal Soil Moisture-Temperature Coupling"

**Manuscript ID:** 2025EF007293
**Journal:** Earth's Future
**Corresponding Author:** Li Dan (danli@tea.ac.cn)

---

## 1. Overview

This repository contains the analysis and visualization scripts required to reproduce all figures in the manuscript. The repository is structured to separate code (`/scripts/`) from data (`/data/`).

**A Note on Reproducibility for Reviewers:**
The full data preprocessing pipeline is computationally intensive. To facilitate an efficient review, we provide a complete set of **pre-processed, intermediate data files** that serve as the direct input for the analysis scripts. Reviewers are **not expected** to run the initial data preprocessing steps. The scripts for these steps are provided in `/scripts/00.preprocessing/` for archival transparency only.

With the provided intermediate data, all figures in the manuscript can be reproduced.

---

## 2. System & Software Requirements

* **NCAR Command Language (NCL):** Version 6.6.2
* **Python:** Version 3.12 (with libraries: `xarray`, `numpy`, `scipy`, `matplotlib`, `pandas`)

---

## 3. Data Structure

All required data for running the analysis scripts should be downloaded and placed in a master `/data/` directory, structured as follows:

* **Download Link:** The complete dataset can be downloaded from:
    **Zenodo:** (https://doi.org/10.5281/zenodo.17103311)

* **Directory Structure:**
    ```
    data/
    ├── climatology/          <-- Data for the climatological analysis (1979-2019)
    │   ├── origin/           <-- Daily pre-processed data (output of Step 0)
    │   ├── eof/              <-- EOF analysis results (output of Step 1)
    │   └── filtered/         <-- Filtered time series (output of Step 2)
    │
    └── 2019/                 <-- Data for the 2019 heatwave case study
        ├── origin/
        ├── eof/
        └── filtered/
    ```

---

## 4. Code Workflow & Figure Reproduction

The analysis scripts are located in the `/scripts/` directory, organized into sub-folders that should be run sequentially. All scripts use relative paths to access data from the `../data/` directory.

### Step 0: Data Preprocessing & Figure 1 Generation (`/scripts/00.preprocessing/`)

**Note:** The scripts in this folder are provided for archival transparency to show how the raw data was processed and how Figure 1 was generated. Reviewers are not expected to run the computationally intensive `cal_*.ncl` scripts.

This directory contains two types of scripts:

**1. Raw Data Integration (Computationally Intensive - For Reference Only):**
These scripts handle the initial processing of the raw, hourly ERA5-Land data for the entire East Asia domain (0-55°N, 90-135°E).

* **Scripts:** `cal_sm.ncl`, `cal_t2m.ncl`, `cal_slhf.ncl`, `cal_sshf.ncl`, `cal_rn.ncl`, `cal_pet.ncl`
* **Function:**
    * Reads and integrates the massive raw hourly ERA5-Land datasets.
    * Calculates daily averages for key variables (soil moisture, 2m air temperature, latent heat, sensible heat, net radiation, potential evaporation).
* **Note:** The output of each of these scripts is a very large NetCDF file (~2.2 GB), which is why this raw processed data is not included in the downloadable dataset.

**2. Figure 1 Generation:**
These scripts use the large, pre-processed East Asia daily data (generated by the scripts above) to create the different panels of Figure 1.

* **Script:** `00.cal_paip.ncl` 
    * **Function:** Calculates the STC-π index from the daily processed variables.

* **Script:** `01.plot_contour.ncl`
    * **Function:** Generates the seasonal climatology maps of the STC-Π index over East Asia for 1979-2019.
    * **Output:** **Figure 1 (a-d)**.

* **Script:** `02.ts2paip.ncl` & `03.wavelet.ncl`
    * **Function:** Performs regional averaging over the LLH-ICP study area, plots the daily time series (climatology and individual years), and conducts the Mexican-hat wavelet analysis.
    * **Output:** **Figure 1 (e, f)**.

### Step 1: Dominant Mode Analysis (EOF) (`/scripts/01.eof/`)

**Note:** The EOF calculation script (`02.daily_eof.ncl`) in this folder is **extremely time-consuming (~4 days runtime)** due to the daily resolution over a 41-year period and the computationally expensive regional masking process. **Reviewers are not expected to run this script.** All necessary output files from this step are included in the downloadable dataset, allowing for the rapid reproduction of Figure 2.

* **Script:** `02.daily_eof.ncl`
    * **Function:** Performs a daily EOF analysis for the spring season (1979-2019) on soil moisture, surface air temperature, and the STC-π index. The analysis is masked to the LLH-ICP study region using the `gms.shp` shapefile.
    * **Status:** **Computationally Intensive (Runtime: ~4 days). FOR REFERENCE ONLY.**
    * **Output:** Generates the EOF spatial patterns (`mam_*2eof4icp_gms.nc`) and principal component time series (`mam_*2ts4icp_gms.nc`). These files are saved to `/data/climatology/eof/` and are provided in the main dataset download.

* **Script:** `03.plot_eof.ncl`
    * **Function:** Reads the pre-computed EOF results from the `/data/climatology/eof/` directory and generates all panels for Figure 2.
    * **Status:** **Fast (Runtime: < 5 minute). Recommended for verification.**
    * **Output:** **Figure 2**.

### Step 2: Frequency Heterogeneity Analysis (`/scripts/02.fre_heter/`)

This folder contains scripts to analyze the frequency characteristics of the dominant STC mode (the PC1 time series from Step 1) and to test the spatial representativeness of the resulting frequency components.

* **Script:** `04.chp4icp.ncl`
    * **Function:** Performs the Cross-Power Spectral Density (CPSD) analysis on the PC1 time series of soil moisture and surface air temperature.
    * **Status:** **Fast (Runtime: < 5 minute).**
    * **Output:** **Figure 3 (a, b)**, showing the coherence and phase spectra.

* **Script:** `05.time_series_projection.ncl`
    * **Function:** Extends the PC1 time series to create periodic padding. This is a preparatory step for filtering to mitigate the boundary effects described by Torrence & Compo (1998).
    * **Status:** **Fast (Runtime: < 1 minute).**
    * **Output:** An intermediate, extended time series file used by the next script.

* **Script:** `06.butterworth_filter.ncl`
    * **Function:** Applies a Butterworth filter to the padded PC1 time series to decompose it into low-frequency (>40 days) and high-frequency (15-20 days) components.
    * **Status:** **Fast (Runtime: < 5 minute).**
    * **Output:** The filtered time series files (`mam_*2ts4icp_gms_filtered.nc`), which are saved to `/data/climatology/filtered/`. 

* **Script:** `07.plot_pc1_time_series.ncl`
    * **Function:** Reads the original PC1 time series and the filtered components and plots their decomposition.
    * **Status:** **Fast (Runtime: < 1 minute).**
    * **Output:** **Figure 3 (c, d)**.

* **Script:** `08.spearman_correlation.ncl`
    * **Function:** Calculates and plots the Spearman correlation between the filtered frequency components and the original gridded data to test for spatial representativeness. This involves the computationally expensive regional masking.
    * **Status:** **Computationally Intensive (Runtime: > 1 hour). FOR REFERENCE ONLY.**
    * **Output:** **Figure 4**. The key data inputs for this script are provided in the dataset, but reviewers should be aware of the long runtime if they choose to rerun it.

### Step 3: Low-Frequency “Slow Feedback” Analysis (`/scripts/03.low_fre/`)

This folder contains the scripts for the detailed mechanistic analysis of the low-frequency (>40 days) land-driven feedback pathway.

**Note:** The NCL scripts for generating the spatial composite maps (`09`, `10`, `12`) are **extremely time-consuming (over 4 hours per script)** due to intensive masking and pixel-wise significance testing. **Reviewers are not expected to run these scripts.** In contrast, the Python script for the phase-space analysis is very fast and highly recommended for verification.

**Spatial Composite Analysis (NCL - Computationally Intensive):**

* **Scripts:** `09.low_freq_phase_composite_t_stc.ncl`, `10.low_freq_phase_composite_sm.ncl`
    * **Function:** Generates the composite spatial distribution maps for soil moisture, surface air temperature, and the STC-π index during the slow feedback's development.
    * **Status:** **Very Slow (Runtime: > 4 hours). FOR REFERENCE ONLY.**
    * **Output:** **Figure 6**.

* **Script:** `12.low_freq_time_series_phase_space_shf...ncl`
    * **Function:** Generates the composite spatial maps for the surface energy fluxes (latent heat, sensible heat, net radiation).
    * **Status:** **Very Slow (Runtime: > 4 hours). FOR REFERENCE ONLY.**
    * **Output:** **Figure 7**.

**Dynamical and Phase-Space Analysis (Python - Fast):**

* **Script:** `21.low_shf_phase_analysis.py`
    * **Function:** Analyzes the regional-average dynamics. It plots the time series of energy fluxes during the typical cycle and generates the phase-space hysteresis loops (SM-LH, LH-SH, SH-T) that visualize the causal chain.
    * **Status:** **Fast (Runtime: < 5 minutes). Recommended for verification.**
    * **Output:** **Figure 8**.

### Step 4: High-Frequency “Fast Response” Analysis (`/scripts/04.high_fre/`)

This folder contains the scripts for the detailed mechanistic analysis of the high-frequency (15-20 days) atmosphere-driven response pathway. The structure mirrors that of the low-frequency analysis.

**Note:** Similar to the low-frequency analysis, the NCL scripts for generating the spatial composite maps in this folder are **computationally intensive (several hours per script)**. **Reviewers are not expected to run them.** The fast Python script provides a quick verification of the core dynamical findings.

**Event Selection & Spatial Composite Analysis (NCL - Computationally Intensive):**

* **Script:** `14.high_freq_sm_cycle_analysis.ncl`
    * **Function:** Identifies all high-frequency cycle events within the climatology and averages them to define a typical cycle. This serves as the basis for the subsequent composite analysis.
    * **Status:** **Computationally Intensive. FOR REFERENCE ONLY.**
    * **Output:** The averaged typical cycle data (`high_freq_sm_avg_cycle_refined.nc`), saved to `/data/climatology/filtered/`. 

* **Scripts:** `15.high_freq_phase_composite_sm.ncl`, `16.high_freq_phase_composite_t_stc.ncl`, `18.high_freq_phase_composite_heat_flux...ncl`
    * **Function:** Generates the composite spatial distribution maps for soil moisture, surface air temperature, STC-π, and all surface energy fluxes during the fast response's development.
    * **Status:** **Very Slow (Runtime: > 4 hours). FOR REFERENCE ONLY.**
    * **Output:** **Figure 9** and **Figure 10**.

**Dynamical and Phase-Space Analysis (Python - Fast):**

* **Script:** `22.high_shf_phase_analysis.py`
    * **Function:** Analyzes the regional-average dynamics of the fast response. It plots the time series of energy fluxes and generates the corresponding phase-space hysteresis loops that visualize the top-down causal chain.
    * **Status:** **Fast (Runtime: < 5 minutes). Recommended for verification.**
    * **Output:** **Figure 11**.

### Step 5: Comprehensive & Cross-Scale Interaction Analysis (`/scripts/05.comprehensive/`)

This folder contains the Python scripts that synthesize the previous analyses to provide a comprehensive view of the dual-pathway dynamics and their nonlinear interaction. As these scripts are Python-based, they are highly efficient and central to the paper's main conclusions.

* **Script:** `20.comprehensive_sm_t_stc_analysis.py`
    * **Function:** Generates a direct, side-by-side comparison of the low- and high-frequency pathways. It plots the regional-average time series for the SM, T, and STC-π components, as well as their respective SM-T phase-space diagrams, to contrast their fundamental dynamical characteristics.
    * **Status:** **Fast (Runtime: < 5 minutes). Recommended for verification.**
    * **Output:** **Figure 5**.

* **Script:** `23.phase_nesting_amplifier_effect.py`
    * **Function:** Visualizes the paper's key finding on cross-scale interaction (the "amplifier effect"). It creates the nested hysteresis loop diagram, showing how the thermal impact of high-frequency events is amplified when they occur during a dry, pre-conditioned low-frequency state.
    * **Status:** **Fast (Runtime: < 5 minutes). Crucial for verifying the paper's core conclusion.**
    * **Output:** **Figure 17**.

### Step 6: 2019 Heatwave Case Study (`/scripts/06.case_study_2019/`)

This folder contains all the scripts necessary to reproduce the analysis and figures for the 2019 heatwave case study (Section 3.4). The analytical workflow largely mirrors that of the climatological analysis but is applied to the specific time period and spatial domain of the 2019 event.

* **Script:** `00.hw4plot.ncl`
    * **Function:** Generates the overview maps of the 2019 heatwave, showing temperature and STC-Π anomalies to highlight the event's severity and justify its selection as a case study.
    * **Status:** **Fast (Runtime: < 2 minutes).**
    * **Output:** **Figure 12**.

* **Script:** `01.daily_eof.ncl`
    * **Function:** Performs a daily EOF analysis for the 2019 event period. Due to the shorter time series, this script is much faster than its climatological counterpart.
    * **Status:** **Moderate Runtime (1-2 hours).** Reviewers can run this if they wish to verify the EOF calculation for the event.
    * **Output:** Generates EOF results for 2019 (`2019_*_eof.nc`, `2019_*_ts.nc`), saved to `/data/2019/eof/`. 

* **Script:** `03.plot_eof.ncl`
    * **Function:** Reads the pre-computed EOF results for the 2019 event and generates the corresponding figure.
    * **Status:** **Fast (Runtime: < 1 minute).**
    * **Output:** **Figure 13**.

* **Scripts:** `04.cpsd_sm_t.ncl`, `07.plot_pc1_time_series.ncl`
    * **Function:** These scripts perform the CPSD and signal decomposition analysis for the 2019 event's dominant mode.
    * **Status:** **Fast (Runtime: < 2 minutes).**
    * **Output:** **Figure 14**.

* **Script:** `12.typical_cycle_analysis.py`
    * **Function:** A Python script that generates the time series and phase-space diagrams for the low- and high-frequency components during the 2019 event, mirroring the analysis of Figure 5.
    * **Status:** **Fast (Runtime: < 5 minutes).**
    * **Output:** **Figure 15**.

* **Script:** `24.heat_flux_timeseries_2019.py`
    * **Function:** A Python script that plots the time series evolution of the surface energy fluxes for both frequency pathways during the 2019 event.
    * **Status:** **Fast (Runtime: < 5 minutes).**
    * **    

---

## 6. Conclusion and Contact

Thank you for taking the time to review our data and code. We have made every effort to ensure this repository is complete and the workflow is as clear as possible.

Should you encounter any issues or have questions while reproducing our results, please do not hesitate to contact the corresponding author for assistance.

**Corresponding Author:** Li Dan (danli@tea.ac.cn)